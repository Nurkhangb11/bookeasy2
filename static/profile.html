<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <section class="profile-section">
        <h2>Your Profile</h2>
        <div id="profile">
            <p>Loading profile...</p>
        </div>
        <button id="logoutButton">Logout</button>
    </section>

    <section>
        <!-- Форма для отправки сообщения -->
        <h3>Contact Support</h3>
        <form id="supportForm" enctype="multipart/form-data">
            <label for="message">Message:</label>
            <textarea id="message" placeholder="Enter your message" required></textarea>

            <label for="attachment">Attach a file (optional):</label>
            <input type="file" id="attachment" name="attachment">

            <button type="submit">Send Message</button>
        </form>
    </section>

    <section class="helpdesk">
        <h3>Helpdesk Chat</h3>
        <div id="chatWindow" style="border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto;">
            <!-- Сообщения чата будут добавляться сюда -->
        </div>
        <textarea id="chatInput" placeholder="Type your message here..." style="width: 100%; margin-top: 10px;"></textarea>
        <button id="sendChatMessage" style="margin-top: 5px;">Send</button>
        <button id="clearChat" style="margin-top: 5px;">Clear Chat</button>
    </section>

    <script>
        const email = localStorage.getItem('email'); // Получаем email из хранилища
        if (!email) {
            window.location.href = "login.html"; // Перенаправляем, если email не найден
        }

        // Функция для получения данных профиля
        async function fetchProfile() {
            const response = await fetch(`http://localhost:8080/profile?email=${email}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const user = await response.json();
                document.getElementById('profile').innerHTML = `
                    <p><strong>First Name:</strong> ${user.first_name}</p>
                    <p><strong>Last Name:</strong> ${user.last_name}</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                `;
            } else {
                document.getElementById('profile').innerHTML = '<p>Error loading profile. Please try again later.</p>';
            }
        }

        // Обработчик формы для отправки сообщения через Helpdesk
        document.getElementById("supportForm").addEventListener("submit", async function (event) {
            event.preventDefault();

            const message = document.getElementById("message").value;

            if (!message) {
                alert("Please enter a message.");
                return;
            }

            try {
                const response = await fetch("http://localhost:8080/send-support-message", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ content: message })
                });

                const data = await response.json();
                if (data.status === "success") {
                    alert("Message sent successfully!");
                } else {
                    alert(data.message || "Failed to send message.");
                }
            } catch (error) {
                console.error("Error sending message:", error);
                alert("An unexpected error occurred. Please try again later.");
            }
        });

        // Загружаем профиль при загрузке страницы
        window.onload = fetchProfile;

        // Логика для выхода из аккаунта
        document.getElementById('logoutButton').addEventListener('click', function () {
            localStorage.removeItem('email'); // Удаляем email из хранилища
            window.location.href = "login.html"; // Перенаправляем на страницу логина
        });

        // Логика для чата
        const chatWindow = document.getElementById('chatWindow');
        const chatInput = document.getElementById('chatInput');
        const sendChatMessage = document.getElementById('sendChatMessage');
        const clearChat = document.getElementById('clearChat');

        // Получить все сообщения
        async function loadMessages() {
            try {
                const response = await fetch("http://localhost:8080/messages", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    }
                });

                const messages = await response.json();
                chatWindow.innerHTML = ''; // Clear current chat window
                messages.forEach(msg => {
                    const messageElement = document.createElement('div');
                    messageElement.textContent = msg.content;
                    chatWindow.appendChild(messageElement);
                });
                chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to the bottom
            } catch (error) {
                console.error("Error fetching messages:", error);
                alert("An error occurred while loading the chat.");
            }
        }

        // Отправить сообщение в чат
        sendChatMessage.addEventListener('click', async () => {
    const message = chatInput.value.trim(); // Убираем лишние пробелы
    if (message) {
        // Блокируем кнопку отправки, чтобы избежать повторных нажатий
        sendChatMessage.disabled = true;    

        try {
            const response = await fetch("http://localhost:8080/send-chat-message", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ message }) // Отправляем объект с ключом "message"
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }

            // Добавляем сообщение в окно чата
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            messageElement.classList.add('chat-message'); // Опционально: добавляем класс для стилизации
            chatWindow.appendChild(messageElement);

            // Очищаем поле ввода и прокручиваем вниз
            chatInput.value = '';
            chatWindow.scrollTop = chatWindow.scrollHeight;
        } catch (error) {
            console.error("Error sending chat message:", error);
            alert("An error occurred while sending the message.");
        } finally {
            // Разблокируем кнопку отправки
            sendChatMessage.disabled = false;
        }
    }
});

        // Очистить чат
        clearChat.addEventListener('click', async () => {
            try {
                const response = await fetch("http://localhost:8080/clear-messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    }
                });

                const data = await response.json();
                if (data.status === "success") {
                    chatWindow.innerHTML = ''; // Clear chat window if successful
                } else {
                    alert(data.message || "Failed to clear messages.");
                }
            } catch (error) {
                console.error("Error clearing chat:", error);
                alert("An error occurred while clearing the chat.");
            }
        });

        // Load existing messages when the page is loaded
        loadMessages();
    </script>
</body>

</html>
